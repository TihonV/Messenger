<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="loadingScreen" class="loading-screen">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div id="appContainer" class="container" style="display:none;">

        <!-- –®–∞–ø–∫–∞ -->
        <header class="header">
            <div class="logo">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>
            <div class="user-controls">
                <span id="currentUserDisplay">–ü—Ä–∏–≤–µ—Ç, <b>–≥–æ—Å—Ç—å</b></span>
                <button id="logoutBtn" onclick="logout()" style="display:none;">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="nav">
            <button onclick="showSection('news')" class="nav-btn active">–õ–µ–Ω—Ç–∞</button>
            <button onclick="showSection('messages')" class="nav-btn">–°–æ–æ–±—â–µ–Ω–∏—è</button>
            <button onclick="showSection('profile')" class="nav-btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </nav>

        <!-- –õ–µ–Ω—Ç–∞ -->
        <section id="newsSection" class="section">
            <div class="post-form">
                <textarea id="postContent" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
                <div class="media-controls">
                    <button onclick="startRecordingAudio()" class="media-btn">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ</button>
                    <button onclick="startRecordingVideo()" class="media-btn">üìπ –í–∏–¥–µ–æ–∫—Ä—É–∂–∫–∞</button>
                </div>
                <button onclick="createPost()" class="submit-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>

            <div id="postsList" class="posts-list">
                <!-- –ü–æ—Å—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </section>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <section id="messagesSection" class="section" style="display:none;">
            <div class="sidebar">
                <h3>–ö–∞–Ω–∞–ª—ã</h3>
                <div id="channelsList" class="channels-list">
                    <!-- –ö–∞–Ω–∞–ª—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                <button onclick="createGroup()" class="sidebar-btn">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                <button onclick="createChannel()" class="sidebar-btn">+ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
            </div>

            <div class="chat-container">
                <div id="currentChannelHeader" class="channel-header">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª
                </div>
                <div id="chatMessages" class="chat-messages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button onclick="toggleStickers()" class="sticker-btn">üòÄ</button>
                    <button onclick="sendMessage()" class="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>

                <!-- –°—Ç–∏–∫–µ—Ä—ã -->
                <div id="stickerPanel" class="sticker-panel">
                    <h4>–°—Ç–∏–∫–µ—Ä—ã</h4>
                    <div id="stickerList" class="sticker-list">
                        <!-- –°—Ç–∏–∫–µ—Ä—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </section>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <section id="profileSection" class="section" style="display:none;">
            <div class="profile-card">
                <h3>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <div class="profile-info">
                    <p><strong>–ò–º—è:</strong> <span id="profileUsername">-</span></p>
                    <p><strong>–ë–∏–æ:</strong> <span id="profileBio">-</span></p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="profileStatus">-</span></p>
                </div>
            </div>
        </section>

    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–≤—Ö–æ–¥–∞ -->
    <div id="authModal" class="modal" style="display:block;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥</h2>
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="usernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="auth-buttons">
                <button onclick="register()" class="btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button onclick="login()" class="btn-secondary">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentChannelId = null;
        let stickers = [];
        let mediaRecorder = null;
        let chunks = [];
        let isRecording = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                loadStickers();
            }, 1000);
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é
        function showSection(section) {
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.getElementById(section + 'Section').style.display = 'block';

            // –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showSection('${section}')"]`).classList.add('active');

            if (section === 'news') {
                loadPosts();
            } else if (section === 'messages') {
                loadChannels();
            }
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            const response = await fetch('/logout', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('authModal').style.display = 'block';
                document.getElementById('currentUserDisplay').textContent = '–ü—Ä–∏–≤–µ—Ç, –≥–æ—Å—Ç—å';
                document.getElementById('logoutBtn').style.display = 'none';
                sessionStorage.clear();
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const result = await response.json();
            if (result.success) {
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                document.getElementById('usernameInput').value = '';
                document.getElementById('passwordInput').value = '';
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.message);
            }
        }

        // –í—Ö–æ–¥
        async function login() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const result = await response.json();
            if (result.success) {
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('currentUserDisplay').textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}`;
                if (result.is_verified) {
                    document.getElementById('currentUserDisplay').innerHTML += ' <img src="https://avatars.mds.yandex.net/i?id=8113f60f587f6d213922a9596da57e63_l-5660145-images-thumbs&n=13" width="16" height="16" alt="Verified">';
                }
                document.getElementById('logoutBtn').style.display = 'inline-block';

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ sessionStorage
                sessionStorage.setItem('username', username);
                sessionStorage.setItem('is_moderator', result.is_moderator);
                sessionStorage.setItem('is_verified', result.is_verified);

                showSection('news');
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.message);
            }
        }

        // –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç
        async function createPost() {
            const content = document.getElementById('postContent').value;
            let audioPath = null;
            let videoPath = null;

            if (window.audioBlob) {
                const formData = new FormData();
                formData.append('audio', window.audioBlob, 'audio.webm');
                const audioResponse = await fetch('/upload_audio', { method: 'POST', body: formData });
                const audioResult = await audioResponse.json();
                if (audioResult.success) audioPath = audioResult.path;
            }

            if (window.videoBlob) {
                const formData = new FormData();
                formData.append('video', window.videoBlob, 'video.webm');
                const videoResponse = await fetch('/upload_video', { method: 'POST', body: formData });
                const videoResult = await videoResponse.json();
                if (videoResult.success) videoPath = videoResult.path;
            }

            const response = await fetch('/create_post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, audio_path: audioPath, video_path: videoPath })
            });
            const result = await response.json();
            if (result.success) {
                document.getElementById('postContent').value = '';
                window.audioBlob = null;
                window.videoBlob = null;
                loadPosts();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.message);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        async function loadPosts() {
            const response = await fetch('/get_posts');
            const posts = await response.json();

            const list = document.getElementById('postsList');
            list.innerHTML = posts.map(post => {
                let content = post.content || '';
                let audioHtml = post.audio_path ? `<audio controls><source src="/uploads/${post.audio_path}" type="audio/webm">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.</audio>` : '';
                let videoHtml = post.video_path ? `<video controls><source src="/uploads/${post.video_path}" type="video/webm">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</video>` : '';
                let verifiedBadge = post.is_verified ? '<img src="https://avatars.mds.yandex.net/i?id=8113f60f587f6d213922a9596da57e63_l-5660145-images-thumbs&n=13" width="16" height="16" alt="Verified">' : '';

                let controls = '';
                if (sessionStorage.getItem('is_moderator') === 'true') {
                    controls = `
                        <div class="post-actions">
                            <button onclick="editPost(${post.id})">‚úèÔ∏è</button>
                            <button onclick="deletePost(${post.id})">üóëÔ∏è</button>
                            ${post.is_verified ? '' : `<button onclick="verifyUser('${post.username}')">‚úÖ</button>`}
                        </div>`;
                }

                return `
                    <div class="post-card">
                        <div class="post-header">
                            <span class="post-author">${post.username} ${verifiedBadge}</span>
                            <span class="post-time">${new Date(post.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="post-content">${content}</div>
                        ${audioHtml}
                        ${videoHtml}
                        ${controls}
                    </div>`;
            }).join('');
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç
        async function editPost(postId) {
            const newContent = prompt('–ù–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:', '');
            if (!newContent) return;
            const response = await fetch(`/edit_post/${postId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: newContent })
            });
            const result = await response.json();
            if (result.success) loadPosts();
            else alert('–û—à–∏–±–∫–∞: ' + result.message);
        }

        // –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç
        async function deletePost(postId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?')) return;
            const response = await fetch(`/delete_post/${postId}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) loadPosts();
            else alert('–û—à–∏–±–∫–∞: ' + result.message);
        }

        // –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function verifyUser(username) {
            if (!confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) return;
            const response = await fetch(`/verify_user/${username}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) loadPosts();
            else alert('–û—à–∏–±–∫–∞: ' + result.message);
        }

        // –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
        async function startRecordingAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                chunks = [];

                mediaRecorder.ondataavailable = event => chunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    window.audioBlob = blob;
                    alert('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ');
                };

                mediaRecorder.start();
                isRecording = true;
                document.querySelector('.media-btn:first-child').textContent = 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            } catch (err) { alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message); }
        }

        // –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ–∫—Ä—É–∂–∫–∏
        async function startRecordingVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                mediaRecorder = new MediaRecorder(stream);
                chunks = [];

                mediaRecorder.ondataavailable = event => chunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    window.videoBlob = blob;
                    alert('–í–∏–¥–µ–æ–∫—Ä—É–∂–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞');
                };

                mediaRecorder.start();
                isRecording = true;
                document.querySelector('.media-btn:last-child').textContent = 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            } catch (err) { alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + err.message); }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
        async function loadChannels() {
            const response = await fetch('/get_channels');
            const channels = await response.json();
            const list = document.getElementById('channelsList');
            list.innerHTML = channels.map(ch => 
                `<div class="channel-item" onclick="selectChannel(${ch.id})">
                    <span>${ch.name}</span>
                    <small>(${ch.type})</small>
                </div>`
            ).join('');
        }

        // –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
        async function createGroup() {
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:');
            if (!name) return;
            const response = await fetch('/create_channel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, type: 'group' })
            });
            const result = await response.json();
            if (result.success) loadChannels();
            else alert('–û—à–∏–±–∫–∞: ' + result.message);
        }

        // –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
        async function createChannel() {
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:');
            if (!name) return;
            const response = await fetch('/create_channel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, type: 'channel' })
            });
            const result = await response.json();
            if (result.success) loadChannels();
            else alert('–û—à–∏–±–∫–∞: ' + result.message);
        }

        // –í—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª
        async function selectChannel(id) {
            currentChannelId = id;
            document.getElementById('currentChannelHeader').textContent = `–ö–∞–Ω–∞–ª: ${id}`;
            loadMessages();
            setInterval(loadMessages, 3000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function loadMessages() {
            if (!currentChannelId) return;
            const response = await fetch(`/get_messages?channel_id=${currentChannelId}`);
            const messages = await response.json();
            const chatDiv = document.getElementById('chatMessages');
            chatDiv.innerHTML = messages.map(msg => {
                const content = msg.message ? msg.message : (msg.sticker ? getStickerEmoji(msg.sticker) : '');
                return `<div class="message-item"><b>${msg.username}:</b> ${content} <i>(${new Date(msg.timestamp).toLocaleTimeString()})</i></div>`;
            }).join('');
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function getStickerEmoji(name) {
            const sticker = stickers.find(s => s.name === name);
            return sticker ? sticker.emoji : '';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–∫–µ—Ä–æ–≤
        async function loadStickers() {
            const response = await fetch('/get_stickers');
            stickers = await response.json();
            const list = document.getElementById('stickerList');
            list.innerHTML = stickers.map(s => 
                `<span class="sticker-item" onclick="sendSticker('${s.name}')">${s.emoji}</span>`
            ).join('');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–∏–∫–µ—Ä—ã
        function toggleStickers() {
            const panel = document.getElementById('stickerPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∏–∫–µ—Ä
        async function sendSticker(name) {
            if (!currentChannelId) return;
            const response = await fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel_id: currentChannelId, sticker: name })
            });
            const result = await response.json();
            if (result.success) {
                loadMessages();
                toggleStickers();
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        async function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message || !currentChannelId) return;
            const response = await fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel_id: currentChannelId, message })
            });
            const result = await response.json();
            if (result.success) {
                document.getElementById('messageInput').value = '';
                loadMessages();
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.querySelector('.close').onclick = () => {
            document.getElementById('authModal').style.display = 'none';
        };

        // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        window.onclick = (event) => {
            if (event.target === document.getElementById('authModal')) {
                document.getElementById('authModal').style.display = 'none';
            }
        };
    </script>
</body>
</html>
